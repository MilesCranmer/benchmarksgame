<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>k-nucleotide Haskell GHC&nbsp;#3 program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding:0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans, Ubuntu, Verdana, sans-serif;margin:0;-webkit-text-size-adjust:100%}h3, h1, h2, li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h3{font-size:1.4em;font-weight:bold;margin:0;padding: .4em}h3, h3 a{color:white;background-color:#77216f}h3 small{font-size:0.64em}h1,h2{margin:1.5em 0 0}h1{font-size:1.4em;font-weight:normal}h2{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin: .5em .5em 0;padding: .5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin: .3em 0 0}p a, a span{border-bottom: .1em solid #333;padding-bottom: .1em}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width: 60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="../favicon.ico">
<header>
  <h3><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/index.html">The&nbsp;<small>Computer&nbsp;Language</small><br>Benchmarks&nbsp;Game</a></h3>
</header>
<article>
  <div>
    <h1>k-nucleotide Haskell GHC&nbsp;#3 program</h1>
    <aside>
      <p><a href="../description/knucleotide.html#knucleotide">description</a>
    </aside>
  </div>
  <section>
    <div>
      <h2>source code</h2>
    </div>
    <pre>
<span class="slc">-- The Computer Language Benchmarks Game</span>
<span class="slc">-- https://salsa.debian.org/benchmarksgame-team/benchmarksgame/</span>
<span class="slc">--</span>
<span class="slc">-- Inspired by version contributed by Branimir Maksimovic</span>
<span class="slc">-- Updated by Callan McGill:</span>
<span class="slc">--   - to use hashmap from unordered containers</span>
<span class="slc">--   - bit encoding of &apos;a&apos;, &apos;c&apos;, &apos;g&apos;, &apos;t&apos;</span>
<span class="slc">--   - Vector streaming framework to re-write algorithm</span>

<span class="kwd">module</span> Main <span class="kwd">where</span>

<span class="kwd">import qualified</span> Control<span class="opt">.</span>Concurrent<span class="opt">.</span>ParallelIO<span class="opt">.</span>Global <span class="kwd">as</span> ParallelIO
<span class="kwd">import</span>           Data<span class="opt">.</span>Bits
<span class="kwd">import</span>           Data<span class="opt">.</span>ByteString                      <span class="opt">(</span>ByteString<span class="opt">)</span>
<span class="kwd">import qualified</span> Data<span class="opt">.</span>ByteString                      <span class="kwd">as</span> ByteString
<span class="kwd">import qualified</span> Data<span class="opt">.</span>ByteString<span class="opt">.</span>Char8                <span class="kwd">as</span> Char8
<span class="kwd">import</span>           Data<span class="opt">.</span>ByteString<span class="opt">.</span>Internal             <span class="opt">(</span>toForeignPtr<span class="opt">)</span>
<span class="kwd">import</span>           Data<span class="opt">.</span>Coerce
<span class="kwd">import</span>           Data<span class="opt">.</span>Hashable
<span class="kwd">import qualified</span> Data<span class="opt">.</span>HashMap<span class="opt">.</span>Internal                <span class="kwd">as</span> Internal
<span class="kwd">import</span>           Data<span class="opt">.</span>HashMap<span class="opt">.</span>Strict                  <span class="opt">(</span>HashMap<span class="opt">)</span>
<span class="kwd">import qualified</span> Data<span class="opt">.</span>HashMap<span class="opt">.</span>Strict                  <span class="kwd">as</span> HashMap
<span class="kwd">import</span>           Data<span class="opt">.</span>List                            <span class="opt">(</span><span class="kwc">foldl</span><span class="opt">&apos;)</span>
<span class="kwd">import</span>           Data<span class="opt">.</span>Primitive<span class="opt">.</span>PVar
<span class="kwd">import qualified</span> Data<span class="opt">.</span>Vector                          <span class="kwd">as</span> Vector
<span class="kwd">import qualified</span> Data<span class="opt">.</span>Vector<span class="opt">.</span>Algorithms<span class="opt">.</span>Intro         <span class="kwd">as</span> Sort
<span class="kwd">import</span>           Data<span class="opt">.</span>Vector<span class="opt">.</span>Fusion<span class="opt">.</span>Stream<span class="opt">.</span>Monadic    <span class="opt">(</span>Step <span class="opt">(..),</span> Stream <span class="opt">(..))</span>
<span class="kwd">import qualified</span> Data<span class="opt">.</span>Vector<span class="opt">.</span>Fusion<span class="opt">.</span>Stream<span class="opt">.</span>Monadic    <span class="kwd">as</span> Stream
<span class="kwd">import qualified</span> Data<span class="opt">.</span>Vector<span class="opt">.</span>Storable                 <span class="kwd">as</span> Storable
<span class="kwd">import</span>           Foreign<span class="opt">.</span>Ptr                          <span class="opt">(</span>castPtr<span class="opt">,</span> plusPtr<span class="opt">)</span>
<span class="kwd">import</span>           GHC<span class="opt">.</span>Word
<span class="kwd">import qualified</span> Text<span class="opt">.</span>Builder                         <span class="kwd">as</span> Builder


main <span class="opt">::</span> <span class="kwb">IO</span> <span class="opt">()</span>
main <span class="opt">=</span> <span class="kwd">do</span>
  <span class="kwd">let</span>
    skip <span class="opt">=</span> <span class="kwd">do</span>
      l <span class="opt">&lt;-</span> ByteString<span class="opt">.</span><span class="kwc">getLine</span>
      <span class="kwd">if</span> Char8<span class="opt">.</span><span class="kwc">isPrefixOf</span> <span class="str">&quot;&gt;THREE&quot;</span> l
          <span class="kwd">then</span> <span class="kwc">return</span> <span class="opt">()</span>
          <span class="kwd">else</span> skip
  skip
  s <span class="opt">&lt;-</span> ByteString<span class="opt">.</span><span class="kwc">getContents</span>
  <span class="kwd">let</span> sv <span class="opt">=</span> byteStringToVector s
  <span class="kwd">let</span>
    content <span class="opt">=</span>
     <span class="slc">-- Remove newlines and only keep the second and third</span>
     <span class="slc">-- bit of each character as in many of the faster solutions.</span>
        Storable<span class="opt">.</span><span class="kwc">map</span> <span class="opt">(</span><span class="esc">\b</span> <span class="opt">-&gt; (</span>b <span class="opt">.&amp;.</span> <span class="num">0</span>b110<span class="opt">)</span> `shiftR` <span class="num">1</span><span class="opt">)</span>
      <span class="opt">.</span> Storable<span class="opt">.</span><span class="kwc">filter</span> <span class="opt">(/=</span> <span class="num">10</span><span class="opt">) $</span> sv
  <span class="slc">-- return results in parallel.</span>
  results <span class="opt">&lt;-</span> ParallelIO<span class="opt">.</span>parallel <span class="opt">(</span>actions content<span class="opt">)</span>
  <span class="slc">-- Put builder results to stdout.</span>
  Builder<span class="opt">.</span>putToStdOut <span class="opt">(</span><span class="kwc">foldl</span><span class="opt">&apos; (&lt;&gt;)</span> mempty results<span class="opt">)</span>

<span class="com">{-# inline actions #-}</span>
<span class="slc">-- Tasks to be run in parallel.</span>
actions <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt; [</span><span class="kwb">IO</span> Builder<span class="opt">.</span>Builder<span class="opt">]</span>
actions content <span class="opt">=</span>
  <span class="opt">[</span> writeFrequencies1 content
  <span class="opt">,</span> writeFrequencies2 content
  <span class="opt">,</span> writeCount content <span class="str">&quot;GGT&quot;</span>
  <span class="opt">,</span> writeCount content <span class="str">&quot;GGTA&quot;</span>
  <span class="opt">,</span> writeCount content <span class="str">&quot;GGTATT&quot;</span>
  <span class="opt">,</span> writeCount content <span class="str">&quot;GGTATTTTAATT&quot;</span>
  <span class="opt">,</span> writeCount content <span class="str">&quot;GGTATTTTAATTTATAGT&quot;</span>
  <span class="opt">]</span>

<span class="slc">-- Write the one-letter frequences into text builder.</span>
writeFrequencies1 <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">IO</span> Builder<span class="opt">.</span>Builder
writeFrequencies1 input <span class="opt">=</span> <span class="kwd">do</span>
    hm <span class="opt">&lt;-</span> calculate1B input
    mv <span class="opt">&lt;-</span> Vector<span class="opt">.</span>unsafeThaw <span class="opt">.</span> Vector<span class="opt">.</span>fromList <span class="opt">.</span> HashMap<span class="opt">.</span>toList <span class="opt">$</span> hm
    Sort<span class="opt">.</span><span class="kwc">sortBy</span> <span class="opt">(\(</span>_<span class="opt">,</span>x<span class="opt">) (</span>_<span class="opt">,</span>y<span class="opt">) -&gt;</span> y `<span class="kwc">compare</span>` x<span class="opt">)</span> mv
    sorted <span class="opt">::</span> Vector<span class="opt">.</span>Vector <span class="opt">(</span>Word8<span class="opt">,</span> <span class="kwb">Int</span><span class="opt">)  &lt;-</span> Vector<span class="opt">.</span>unsafeFreeze <span class="opt">$</span> mv
    <span class="kwd">let</span>
      inputLength <span class="opt">::</span> <span class="kwb">Double</span>
      inputLength <span class="opt">=</span> <span class="kwc">fromIntegral</span> <span class="opt">(</span>Storable<span class="opt">.</span><span class="kwa">length</span> input<span class="opt">)</span>
    <span class="kwd">let</span> b <span class="opt">=</span> Vector<span class="opt">.</span><span class="kwc">foldl</span><span class="opt">&apos; (</span><span class="esc">\a</span>cc <span class="opt">(</span>k<span class="opt">,</span>v<span class="opt">)-&gt;</span>
                      <span class="kwd">let</span>
                        perc <span class="opt">::</span> <span class="kwb">Double</span>
                        perc <span class="opt">=</span> <span class="num">100</span> <span class="opt">* (</span><span class="kwc">fromIntegral</span> v<span class="opt">)/</span>inputLength
                      <span class="kwd">in</span>
                          acc
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">(</span>decode <span class="opt">$</span> k<span class="opt">)</span>
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos; &apos;</span>
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>fixedDouble <span class="num">3</span> perc
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\n</span><span class="opt">&apos;)</span> mempty sorted
    pure <span class="opt">(</span>b <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\n</span><span class="opt">&apos;)</span>

<span class="slc">-- Write the two-letter frequencies into text builder.</span>
writeFrequencies2 <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">IO</span> Builder<span class="opt">.</span>Builder
writeFrequencies2 input <span class="opt">=</span> <span class="kwd">do</span>
    hm <span class="opt">&lt;-</span> calculate2B input
    mv <span class="opt">&lt;-</span> Vector<span class="opt">.</span>unsafeThaw <span class="opt">.</span> Vector<span class="opt">.</span>fromList <span class="opt">.</span> HashMap<span class="opt">.</span>toList <span class="opt">$</span> hm
    Sort<span class="opt">.</span><span class="kwc">sortBy</span> <span class="opt">(\(</span>_<span class="opt">,</span>x<span class="opt">) (</span>_<span class="opt">,</span>y<span class="opt">) -&gt;</span> y `<span class="kwc">compare</span>` x<span class="opt">)</span> mv
    sorted <span class="opt">::</span> Vector<span class="opt">.</span>Vector <span class="opt">(</span>Word16<span class="opt">,</span> <span class="kwb">Int</span><span class="opt">)  &lt;-</span> Vector<span class="opt">.</span>unsafeFreeze <span class="opt">$</span> mv
    <span class="kwd">let</span>
      inputLength <span class="opt">::</span> <span class="kwb">Double</span>
      inputLength  <span class="opt">=</span> <span class="kwc">fromIntegral</span> <span class="opt">(</span>Storable<span class="opt">.</span><span class="kwa">length</span> input<span class="opt">) -</span> <span class="num">1</span>
    <span class="kwd">let</span> b <span class="opt">=</span> <span class="kwc">foldl</span><span class="opt">&apos; (</span><span class="esc">\a</span>cc <span class="opt">(</span>k<span class="opt">,</span>v<span class="opt">)-&gt;</span>
                      <span class="kwd">let</span>
                        perc <span class="opt">::</span> <span class="kwb">Double</span>
                        perc <span class="opt">=</span> <span class="num">100</span> <span class="opt">* (</span><span class="kwc">fromIntegral</span> v<span class="opt">)/</span>inputLength
                      <span class="kwd">in</span>
                          acc
                       <span class="opt">&lt;&gt;</span> decode16 k
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos; &apos;</span>
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>fixedDouble <span class="num">3</span> perc
                       <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\n</span><span class="opt">&apos;)</span> mempty  sorted
    pure <span class="opt">(</span>b <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\n</span><span class="opt">&apos;)</span>

<span class="slc">-- Convert byte back to letter.</span>
decode <span class="opt">::</span> Word8 <span class="opt">-&gt;</span> <span class="kwb">Char</span>
decode <span class="num">0</span> <span class="opt">= &apos;</span>A<span class="opt">&apos;</span>
decode <span class="num">1</span> <span class="opt">= &apos;</span>C<span class="opt">&apos;</span>
decode <span class="num">2</span> <span class="opt">= &apos;</span>T<span class="opt">&apos;</span>
decode <span class="num">3</span> <span class="opt">= &apos;</span>G<span class="opt">&apos;</span>
decode _ <span class="opt">=</span> <span class="kwc">error</span> <span class="str">&quot;decode: encountered unexpected byte&quot;</span>

<span class="slc">-- Convert pair of bytes back to pair of letters</span>
decode16 <span class="opt">::</span> Word16 <span class="opt">-&gt;</span> Builder<span class="opt">.</span>Builder
decode16 <span class="num">0</span>b0000000000000000 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;AA&quot;</span>
decode16 <span class="num">0</span>b0000000000000001 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;AC&quot;</span>
decode16 <span class="num">0</span>b0000000000000010 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;AT&quot;</span>
decode16 <span class="num">0</span>b0000000000000011 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;AG&quot;</span>
decode16 <span class="num">0</span>b0000000100000000 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;CA&quot;</span>
decode16 <span class="num">0</span>b0000000100000001 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;CC&quot;</span>
decode16 <span class="num">0</span>b0000000100000010 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;CT&quot;</span>
decode16 <span class="num">0</span>b0000000100000011 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;CG&quot;</span>
decode16 <span class="num">0</span>b0000001000000000 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;TA&quot;</span>
decode16 <span class="num">0</span>b0000001000000001 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;TC&quot;</span>
decode16 <span class="num">0</span>b0000001000000010 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;TT&quot;</span>
decode16 <span class="num">0</span>b0000001000000011 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;TG&quot;</span>
decode16 <span class="num">0</span>b0000001100000000 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;GA&quot;</span>
decode16 <span class="num">0</span>b0000001100000001 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;GC&quot;</span>
decode16 <span class="num">0</span>b0000001100000010 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;GT&quot;</span>
decode16 <span class="num">0</span>b0000001100000011 <span class="opt">=</span> Builder<span class="opt">.</span>text <span class="str">&quot;GG&quot;</span>
decode16 n                  <span class="opt">=</span> <span class="kwc">error</span> <span class="opt">$</span> <span class="str">&quot;decode16: unexpected bits: &quot;</span> <span class="opt">&lt;&gt;</span> <span class="kwc">show</span> n


<span class="slc">-- Compute hashmap of single character occurences</span>
calculate1B <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Word8 <span class="kwb">Int</span><span class="opt">)</span>
calculate1B input <span class="opt">=</span> Storable<span class="opt">.</span><span class="kwc">foldM</span><span class="opt">&apos;</span> updateMap HashMap<span class="opt">.</span><span class="kwa">empty</span> input <span class="opt">&gt;&gt;=</span> traverse readPVar
  <span class="kwd">where</span>
    updateMap
      <span class="opt">::</span> HashMap Word8 <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">)</span>
      <span class="opt">-&gt;</span> Word8
      <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Word8 <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">))</span>
    updateMap freqmap word <span class="opt">=</span>
         <span class="kwd">case</span> HashMap<span class="opt">.</span><span class="kwc">lookup</span> word freqmap <span class="kwd">of</span>
            Nothing <span class="opt">-&gt;</span>
              <span class="kwd">do</span>
                ref <span class="opt">&lt;-</span> newPVar <span class="num">1</span>
                <span class="kwd">let</span>
                  freqmap<span class="opt">&apos;</span>
                  <span class="slc">-- Use insertNewKey as we know key is not present</span>
                      <span class="opt">=</span> Internal<span class="opt">.</span>insertNewKey <span class="opt">(</span><span class="kwc">fromIntegral</span> word<span class="opt">)</span> word ref freqmap
                pure freqmap<span class="opt">&apos;</span>
                   <span class="slc">-- Mutate reference over copying hashmap on insert.</span>
            Just x <span class="opt">-&gt;</span> modifyPVar_ x <span class="opt">(+</span><span class="num">1</span><span class="opt">) &gt;&gt;</span> pure freqmap


<span class="slc">-- Compute hashmap of two-character occurences.</span>
calculate2B <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Word16 <span class="kwb">Int</span><span class="opt">)</span>
calculate2B input <span class="opt">=</span> fold16M updateMap HashMap<span class="opt">.</span><span class="kwa">empty</span> input <span class="opt">&gt;&gt;=</span> traverse readPVar
  <span class="kwd">where</span>
    updateMap
      <span class="opt">::</span> HashMap Word16 <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">)</span>
      <span class="opt">-&gt;</span> Word16
      <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Word16 <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">))</span>
    updateMap freqmap word <span class="opt">=</span>
         <span class="kwd">case</span> HashMap<span class="opt">.</span><span class="kwc">lookup</span> word freqmap <span class="kwd">of</span>
            Nothing <span class="opt">-&gt;</span>
              <span class="kwd">do</span>
                ref <span class="opt">&lt;-</span> newPVar <span class="num">1</span>
                <span class="kwd">let</span>
                  freqmap<span class="opt">&apos;</span>
                  <span class="slc">-- Use insertNewKey as we know key is not present</span>
                      <span class="opt">=</span> Internal<span class="opt">.</span>insertNewKey <span class="opt">(</span><span class="kwc">fromIntegral</span> word<span class="opt">)</span> word ref freqmap
                pure freqmap<span class="opt">&apos;</span>
                   <span class="slc">-- Mutate reference over copying hashmap on insert.</span>
            Just x <span class="opt">-&gt;</span> modifyPVar_ x <span class="opt">(+</span><span class="num">1</span><span class="opt">) &gt;&gt;</span> pure freqmap


<span class="com">{-# INLINE writeCount #-}</span>
<span class="slc">-- Write number of occurences of string in input.</span>
writeCount <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> ByteString <span class="opt">-&gt;</span> <span class="kwb">IO</span> Builder<span class="opt">.</span>Builder
writeCount input <span class="kwa">string</span> <span class="opt">=</span> <span class="kwd">do</span>
    <span class="kwd">let</span> size <span class="opt">=</span> Char8<span class="opt">.</span><span class="kwa">length string</span>
    <span class="kwd">let</span> stringV <span class="opt">=</span> byteStringToVector <span class="kwa">string</span>
    <span class="kwd">let</span> encoded <span class="opt">=</span> Storable<span class="opt">.</span><span class="kwc">map</span> <span class="opt">(</span><span class="esc">\b</span> <span class="opt">-&gt; (</span>b <span class="opt">.&amp;.</span> <span class="num">0</span>b110<span class="opt">)</span> `shiftR` <span class="num">1</span><span class="opt">) $</span> stringV
    hm <span class="opt">&lt;-</span> tcalculate input size
    <span class="kwd">let</span>
      v <span class="opt">::</span> <span class="kwb">Int</span>
      v <span class="opt">=</span> <span class="kwc">maybe</span> <span class="num">0</span> <span class="kwc">id</span> <span class="opt">$</span> HashMap<span class="opt">.</span><span class="kwc">lookup</span> <span class="opt">(</span>coerce encoded<span class="opt">)</span> hm
    <span class="kwd">let</span> b <span class="opt">=</span> Builder<span class="opt">.</span>unsignedDecimal v <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\t</span><span class="opt">&apos; &lt;&gt;</span> Builder<span class="opt">.</span>asciiByteString <span class="kwa">string</span>
    pure <span class="opt">(</span>b <span class="opt">&lt;&gt;</span> Builder<span class="opt">.</span>char <span class="opt">&apos;</span><span class="esc">\n</span><span class="opt">&apos;)</span>

<span class="slc">-- Compute hashmaps in parallel over given increment</span>
<span class="slc">-- and then re-combine.</span>
tcalculate <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">Int</span> <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Incremental <span class="kwb">Int</span><span class="opt">)</span>
tcalculate input size <span class="opt">=</span> <span class="kwd">do</span>
    <span class="kwd">let</span>
      computeHashMaps <span class="opt">=</span> <span class="kwc">map</span> <span class="opt">(\</span>i <span class="opt">-&gt;</span> calculate input i size <span class="num">64</span><span class="opt">) [</span><span class="num">0</span><span class="opt">.</span><span class="num">.63</span><span class="opt">]</span>
    results <span class="opt">&lt;-</span> ParallelIO<span class="opt">.</span>parallel computeHashMaps
    <span class="kwc">return</span>
      <span class="opt">$</span> <span class="kwc">foldl</span><span class="opt">&apos; (\</span> acc hm <span class="opt">-&gt;</span> HashMap<span class="opt">.</span>unionWith <span class="opt">(+)</span> acc hm<span class="opt">)</span> HashMap<span class="opt">.</span><span class="kwa">empty</span> results

<span class="slc">-- Compute hashmap from given beginning point with the given increment.</span>
calculate <span class="opt">::</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">Int</span> <span class="opt">-&gt;</span> <span class="kwb">Int</span> <span class="opt">-&gt;</span> <span class="kwb">Int</span> <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Incremental <span class="kwb">Int</span><span class="opt">)</span>
calculate input <span class="opt">!</span>beg <span class="opt">!</span>size <span class="opt">!</span>incr <span class="opt">=</span>
    Stream<span class="opt">.</span><span class="kwc">foldM</span><span class="opt">&apos;</span> updateHashMap HashMap<span class="opt">.</span><span class="kwa">empty</span> <span class="opt">(</span>fromVectorWithInc beg size incr end input<span class="opt">) &gt;&gt;=</span>
    traverse readPVar
  <span class="kwd">where</span>
    end <span class="opt">=</span> Storable<span class="opt">.</span><span class="kwa">length</span> input <span class="opt">+</span> <span class="num">1</span> <span class="opt">-</span> size
    updateHashMap
      <span class="opt">::</span> HashMap Incremental <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">)</span>
      <span class="opt">-&gt;</span> Incremental
      <span class="opt">-&gt;</span> <span class="kwb">IO</span> <span class="opt">(</span>HashMap Incremental <span class="opt">(</span>PVar <span class="kwb">Int</span> RW<span class="opt">))</span>
    updateHashMap freqmap slice <span class="opt">=</span>
         <span class="kwd">case</span> HashMap<span class="opt">.</span><span class="kwc">lookup</span> slice freqmap <span class="kwd">of</span>
            Nothing <span class="opt">-&gt;</span> <span class="kwd">do</span>
              ref <span class="opt">&lt;-</span> newPVar <span class="num">1</span>
              <span class="kwd">let</span>
                freqmap<span class="opt">&apos;</span>
                    <span class="opt">=</span> Internal<span class="opt">.</span>insertNewKey <span class="opt">(</span><span class="kwc">fromIntegral</span> <span class="opt">(</span>hash slice<span class="opt">))</span> slice ref freqmap
              pure freqmap<span class="opt">&apos;</span>
            Just x <span class="opt">-&gt;</span> modifyPVar_ x <span class="opt">(+</span><span class="num">1</span><span class="opt">) &gt;&gt;</span> pure freqmap


<span class="kwd">newtype</span> Incremental <span class="opt">=</span> Incremental <span class="opt">(</span>Storable<span class="opt">.</span>Vector Word8<span class="opt">)</span>
  <span class="kwd">deriving newtype</span> Eq

<span class="slc">-- Use a custom hashable instance using the bit values we</span>
<span class="slc">-- have extracted from the input</span>
<span class="kwd">instance</span> Hashable Incremental <span class="kwd">where</span>
  hash <span class="opt">(</span>Incremental v<span class="opt">) =</span>
    Storable<span class="opt">.</span><span class="kwc">foldl</span><span class="opt">&apos;</span>
    <span class="opt">(\</span> acc w <span class="opt">-&gt; (</span>acc `shiftL` <span class="num">2</span><span class="opt">) .</span>|<span class="opt">. (</span><span class="kwc">fromIntegral</span> w<span class="opt">))</span>
    <span class="num">0</span>
    v
  hashWithSalt _ <span class="opt">=</span> <span class="kwc">error</span> <span class="str">&quot;hashWithSalt not implemented.&quot;</span>

<span class="slc">-- Convert a bytestring to a storable vector without copying.</span>
<span class="slc">-- Taken from: bytestring-to-vector package</span>
byteStringToVector <span class="opt">::</span> ByteString <span class="opt">-&gt;</span> Storable<span class="opt">.</span>Vector Word8
byteStringToVector bs <span class="opt">=</span> vec <span class="kwd">where</span>
    vec <span class="opt">=</span> Storable<span class="opt">.</span>unsafeFromForeignPtr fptr off len
    <span class="opt">(</span>fptr<span class="opt">,</span> off<span class="opt">,</span> len<span class="opt">) =</span> toForeignPtr bs


fold16M <span class="opt">:: (</span>a <span class="opt">-&gt;</span> Word16 <span class="opt">-&gt;</span> <span class="kwb">IO</span> a<span class="opt">) -&gt;</span> a <span class="opt">-&gt;</span> Storable<span class="opt">.</span>Vector Word8 <span class="opt">-&gt;</span> <span class="kwb">IO</span> a
fold16M f v vec <span class="opt">=</span> <span class="kwd">do</span>
     Storable<span class="opt">.</span>unsafeWith vec <span class="opt">$ \</span>ptr <span class="opt">-&gt;</span> go v ptr <span class="opt">(</span>ptr `plusPtr` <span class="opt">(</span>len <span class="opt">-</span> <span class="num">1</span><span class="opt">))</span>
  <span class="kwd">where</span>
    len <span class="opt">=</span> Storable<span class="opt">.</span><span class="kwa">length</span> vec
        <span class="slc">-- tail recursive; traverses array left to right</span>
    go <span class="opt">!</span>z <span class="opt">!</span>p end | p <span class="opt">==</span> end <span class="opt">=</span> <span class="kwc">return</span> z
                  | <span class="kwc">otherwise</span> <span class="opt">=</span>
                    <span class="kwd">do</span>
                      x <span class="opt">&lt;-</span> peek <span class="opt">(</span>castPtr <span class="opt">&#64;</span>_ <span class="opt">&#64;</span>Word16 p<span class="opt">)</span>
                      z<span class="opt">&apos; &lt;-</span> f z x
                      go z<span class="opt">&apos; (</span>p `plusPtr` <span class="num">1</span><span class="opt">)</span> end



<span class="com">{-# inline fromVectorWithInc #-}</span>
fromVectorWithInc
  <span class="opt">::</span> <span class="kwd">forall</span> m <span class="opt">. (</span>Monad m<span class="opt">)</span>
  <span class="opt">=&gt;</span> <span class="kwb">Int</span>
  <span class="opt">-&gt;</span> <span class="kwb">Int</span>
  <span class="opt">-&gt;</span> <span class="kwb">Int</span>
  <span class="opt">-&gt;</span> <span class="kwb">Int</span>
  <span class="opt">-&gt;</span> Storable<span class="opt">.</span>Vector Word8
  <span class="opt">-&gt;</span> Stream m Incremental
fromVectorWithInc beg size inc end v <span class="opt">=</span> Stream step beg
  <span class="kwd">where</span>
    <span class="com">{-# INLINE step #-}</span>
    step <span class="opt">::</span> <span class="kwb">Int</span> <span class="opt">-&gt;</span> m <span class="opt">(</span>Step <span class="kwb">Int</span> Incremental<span class="opt">)</span>
    step <span class="opt">!</span>i | i <span class="opt">&gt;=</span> end <span class="opt">=</span> <span class="kwc">return</span> Done
            | <span class="kwc">otherwise</span> <span class="opt">=</span> <span class="kwc">return</span> <span class="opt">$</span> Yield <span class="opt">(</span>coerce <span class="opt">(</span>Storable<span class="opt">.</span>unsafeSlice i size v<span class="opt">)) (</span>i<span class="opt">+</span>inc<span class="opt">)</span>
    </pre>
  </section>
  <section>
    <div>
      <h2 id="log">notes, command-line, and program output</h2>
    </div>
    <pre>
NOTES:
64-bit Ubuntu quad core
The Glorious Glasgow Haskell Compilation System,
version 8.10.1


Thu, 18 Feb 2021 18:16:12 GMT

MAKE:
mv knucleotide.ghc-3.ghc knucleotide.ghc-3.hs
/opt/src/ghc-8.10.1/bin/ghc --make -fllvm -O2 -XBangPatterns -threaded -rtsopts -funbox-strict-fields -XBinaryLiterals -XDerivingStrategies -XGeneralizedNewtypeDeriving -XOverloadedStrings -XScopedTypeVariables -XTypeApplications knucleotide.ghc-3.hs -o knucleotide.ghc-3.ghc_run
Loaded package environment from /home/dunham/.ghc/x86_64-linux-8.10.1/environments/default
[1 of 1] Compiling Main             ( knucleotide.ghc-3.hs, knucleotide.ghc-3.o )

knucleotide.ghc-3.hs:12:1: error:
    Could not find module ‘Control.Concurrent.ParallelIO.Global’
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
12 | import qualified Control.Concurrent.ParallelIO.Global as ParallelIO
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:20:1: error:
    Could not find module ‘Data.HashMap.Internal’
    Perhaps you meant
      Data.IntMap.Internal (from containers-0.6.2.1)
      Data.Map.Internal (from containers-0.6.2.1)
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
20 | import qualified Data.HashMap.Internal                as Internal
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:21:1: error:
    Could not find module ‘Data.HashMap.Strict’
    Perhaps you meant
      Data.IntMap.Strict (from containers-0.6.2.1)
      Data.Map.Strict (from containers-0.6.2.1)
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
21 | import           Data.HashMap.Strict                  (HashMap)
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:22:1: error:
    Could not find module ‘Data.HashMap.Strict’
    Perhaps you meant
      Data.IntMap.Strict (from containers-0.6.2.1)
      Data.Map.Strict (from containers-0.6.2.1)
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
22 | import qualified Data.HashMap.Strict                  as HashMap
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:24:1: error:
    Could not find module ‘Data.Primitive.PVar’
    Perhaps you meant
      Data.Primitive.MVar (needs flag -package-key primitive-0.7.1.0)
      Data.Primitive.Ptr (needs flag -package-key primitive-0.7.1.0)
      Data.Primitive.MutVar (needs flag -package-key primitive-0.7.1.0)
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
24 | import           Data.Primitive.PVar
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:26:1: error:
    Could not find module ‘Data.Vector.Algorithms.Intro’
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
26 | import qualified Data.Vector.Algorithms.Intro         as Sort
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

knucleotide.ghc-3.hs:32:1: error:
    Could not find module ‘Text.Builder’
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
   |
32 | import qualified Text.Builder                         as Builder
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
make: [/home/dunham/all-benchmarksgame/2000-benchmarksgame/nanobench/makefiles/u64q.programs.Makefile:243: knucleotide.ghc-3.ghc_run] Error 1 (ignored)
rm knucleotide.ghc-3.hs

0.41s to complete and log all make actions

COMMAND LINE:
./knucleotide.ghc-3.ghc_run +RTS -N4 -K2048M -RTS 0 &lt; knucleotide-input250000.txt

MAKE ERROR 

    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="../license.html"><span>3-Clause BSD License</span></a>
    </ul>
  </nav>
</footer>

