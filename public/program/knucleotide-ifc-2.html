<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>k-nucleotide Fortran Intel&nbsp;#2 program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding:0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans, Ubuntu, Verdana, sans-serif;margin:0;-webkit-text-size-adjust:100%}h3, h1, h2, li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h3{font-size:1.4em;font-weight:bold;margin:0;padding: .4em}h3, h3 a{color:white;background-color:#dd4814}h3 small{font-size:0.64em}h1,h2{margin:1.5em 0 0}h1{font-size:1.4em;font-weight:normal}h2{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin: .5em .5em 0;padding: .5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin: .3em 0 0}p a, a span{border-bottom: .1em solid #333;padding-bottom: .1em}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width: 60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="./favicon.ico">
<header>
  <h3><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/">The&nbsp;<small>Computer&nbsp;Language</small><br>Benchmarks&nbsp;Game</a></h3>
</header>
<article>
  <div>
    <h1>k-nucleotide Fortran Intel&nbsp;#2 program</h1>
    <aside>
      <p><a href="../description/knucleotide.html#knucleotide">description</a>
    </aside>
  </div>
  <section>
    <div>
      <h2>source code</h2>
    </div>
    <pre>
<span class="slc">! The Computer Language Benchmarks Game</span>
<span class="slc">! https://salsa.debian.org/benchmarksgame-team/benchmarksgame/</span>
<span class="slc">!</span>
<span class="slc">! Author: Jannis Teunissen</span>
<span class="slc">!</span>
<span class="slc">! Based on:</span>
<span class="slc">! - The Fortran contribution of Steve Decker</span>
<span class="slc">! - The C contribution of Jeremy Zerfas</span>
<span class="slc">!</span>
<span class="slc">! Compilation:</span>
<span class="slc">! gfortran -O3 -fomit-frame-pointer -march=core2 -fopenmp knucleotide.f90</span>
<span class="slc">! ifort -O3 -march=core2 -qopenmp knucleotide.f90</span>

<span class="kwa">module</span> hash_table
  <span class="kwa">use</span> iso_fortran_env

  <span class="kwa">implicit none</span>
  private
  public <span class="opt">::</span> init_table<span class="opt">,</span> add<span class="opt">,</span> get_keys<span class="opt">,</span> get_count

  <span class="kwa">type</span><span class="opt">,</span> public <span class="opt">::</span> <span class="kwa">key</span>
     <span class="kwa">integer</span>        <span class="opt">::</span> count <span class="opt">=</span> <span class="num">0</span>
     <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">) ::</span> word
  <span class="kwa">end type key</span>

  <span class="kwa">type</span><span class="opt">,</span> public <span class="opt">::</span> table
     private
     <span class="kwa">integer</span> <span class="opt">::</span> hashBits<span class="opt">,</span> maxWords<span class="opt">,</span> nWords
     <span class="kwa">type</span><span class="opt">(</span><span class="kwa">key</span><span class="opt">),</span> allocatable<span class="opt">,</span> <span class="kwa">dimension</span><span class="opt">(:) ::</span> words
  <span class="kwa">end type</span> table

<span class="kwa">contains</span>

  pure <span class="kwa">subroutine</span> <span class="kwd">init_table</span><span class="opt">(</span>kNuc<span class="opt">,</span> nBits<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>out<span class="opt">) ::</span> kNuc
    <span class="kwa">integer</span><span class="opt">,</span>     <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)  ::</span> nBits

    kNuc <span class="opt">=</span> <span class="kwd">table</span><span class="opt">(</span>nBits<span class="opt">,</span> <span class="num">2</span><span class="opt">**</span>nBits<span class="opt">,</span> <span class="num">0</span><span class="opt">,</span> <span class="kwd">null</span><span class="opt">())</span>
    <span class="kwd">allocate</span><span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>kNuc<span class="opt">%</span>maxWords<span class="opt">))</span>
  <span class="kwa">end subroutine</span> init_table

  <span class="kwa">subroutine</span> <span class="kwd">add</span><span class="opt">(</span>kNuc<span class="opt">,</span> word<span class="opt">,</span> key_bytes<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span>      <span class="kwd">intent</span><span class="opt">(</span>inout<span class="opt">) ::</span> kNuc
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)      ::</span> word
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)             ::</span> key_bytes
    <span class="kwa">integer</span>                         <span class="opt">::</span> m<span class="opt">,</span> hash

    <span class="kwa">call</span> <span class="kwd">djb2_hash_int64</span><span class="opt">(</span>word<span class="opt">,</span> key_bytes<span class="opt">,</span> hash<span class="opt">)</span>
    m <span class="opt">=</span> <span class="kwd">iand</span><span class="opt">(</span>hash<span class="opt">,</span> kNuc<span class="opt">%</span>maxWords<span class="opt">-</span><span class="num">1</span><span class="opt">) +</span> <span class="num">1</span>

    <span class="kwa">do</span>
       <span class="kwa">if</span> <span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">==</span> <span class="num">0</span><span class="opt">)</span> <span class="kwa">then</span>
          kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">=</span> <span class="num">1</span>
          kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>word <span class="opt">=</span> word
          kNuc<span class="opt">%</span>nWords <span class="opt">=</span> kNuc<span class="opt">%</span>nWords <span class="opt">+</span> <span class="num">1</span>
          <span class="kwa">if</span> <span class="opt">(</span>kNuc<span class="opt">%</span>nWords <span class="opt">&gt;</span> kNuc<span class="opt">%</span>maxWords<span class="opt">/</span><span class="num">2</span><span class="opt">)</span> <span class="kwa">call</span> <span class="kwd">resize_table</span><span class="opt">(</span>kNuc<span class="opt">,</span> key_bytes<span class="opt">)</span>
          exit
       <span class="kwa">else if</span> <span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>word <span class="opt">==</span> word<span class="opt">)</span> <span class="kwa">then</span>
          kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">=</span> kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">+</span> <span class="num">1</span>
          exit
       <span class="kwa">end if</span>
       m <span class="opt">=</span> <span class="kwd">merge</span><span class="opt">(</span><span class="num">1</span><span class="opt">,</span> m<span class="opt">+</span><span class="num">1</span><span class="opt">,</span> m <span class="opt">==</span> kNuc<span class="opt">%</span>maxWords<span class="opt">)</span>
    <span class="kwa">end do</span>

  <span class="kwa">end subroutine</span> add

  <span class="kwa">subroutine</span> <span class="kwd">resize_table</span><span class="opt">(</span>kNuc<span class="opt">,</span> key_bytes<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>inout<span class="opt">) ::</span> kNuc
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)        ::</span> key_bytes

    <span class="kwa">integer</span>     <span class="opt">::</span> i<span class="opt">,</span> m<span class="opt">,</span> hash
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">) ::</span> temp

    temp <span class="opt">=</span> <span class="kwd">table</span><span class="opt">(</span>kNuc<span class="opt">%</span>hashBits <span class="opt">+</span> <span class="num">1</span><span class="opt">,</span> <span class="num">2</span> <span class="opt">*</span> kNuc<span class="opt">%</span>maxWords<span class="opt">,</span> kNuc<span class="opt">%</span>nWords<span class="opt">,</span> <span class="kwd">null</span><span class="opt">())</span>
    <span class="kwd">allocate</span><span class="opt">(</span>temp<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>temp<span class="opt">%</span>maxWords<span class="opt">))</span>

    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> kNuc<span class="opt">%</span>maxWords
       <span class="kwa">if</span> <span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>i<span class="opt">)%</span>count <span class="opt">&gt;</span> <span class="num">0</span><span class="opt">)</span> <span class="kwa">then</span>
          <span class="kwa">call</span> <span class="kwd">djb2_hash_int64</span><span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>i<span class="opt">)%</span>word<span class="opt">,</span> key_bytes<span class="opt">,</span> hash<span class="opt">)</span>
          m <span class="opt">=</span> <span class="kwd">iand</span><span class="opt">(</span>hash<span class="opt">,</span> temp<span class="opt">%</span>maxWords<span class="opt">-</span><span class="num">1</span><span class="opt">) +</span> <span class="num">1</span>
          <span class="kwa">do</span>
             <span class="kwa">if</span> <span class="opt">(</span>temp<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">==</span> <span class="num">0</span><span class="opt">)</span> <span class="kwa">then</span>
                temp<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">) =</span> kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>i<span class="opt">)</span>
                exit
             <span class="kwa">end if</span>
             m <span class="opt">=</span> <span class="kwd">merge</span><span class="opt">(</span><span class="num">1</span><span class="opt">,</span> m<span class="opt">+</span><span class="num">1</span><span class="opt">,</span> m <span class="opt">==</span> temp<span class="opt">%</span>maxWords<span class="opt">)</span>
          <span class="kwa">end do</span>
       <span class="kwa">end if</span>
    <span class="kwa">end do</span>

    kNuc <span class="opt">=</span> temp
  <span class="kwa">end subroutine</span> resize_table

  pure <span class="kwa">function</span> <span class="kwd">get_keys</span><span class="opt">(</span>kNuc<span class="opt">,</span> n_max<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">) ::</span> kNuc
    <span class="kwa">integer</span><span class="opt">,</span>     <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">) ::</span> n_max
    <span class="kwa">type</span><span class="opt">(</span><span class="kwa">key</span><span class="opt">)               ::</span> <span class="kwd">get_keys</span><span class="opt">(</span>n_max<span class="opt">)</span>
    <span class="kwa">integer</span>                 <span class="opt">::</span> i<span class="opt">,</span> n

    n <span class="opt">=</span> <span class="num">0</span>
    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> kNuc<span class="opt">%</span>maxWords
       <span class="kwa">if</span> <span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>i<span class="opt">)%</span>count <span class="opt">&gt;</span> <span class="num">0</span><span class="opt">)</span> <span class="kwa">then</span>
          n <span class="opt">=</span> n <span class="opt">+</span> <span class="num">1</span>
          <span class="kwd">get_keys</span><span class="opt">(</span>n<span class="opt">) =</span> kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>i<span class="opt">)</span>
          <span class="kwa">if</span> <span class="opt">(</span>n <span class="opt">&gt;=</span> <span class="kwd">size</span><span class="opt">(</span>get_keys<span class="opt">))</span> exit
       <span class="kwa">end if</span>
    <span class="kwa">end do</span>
  <span class="kwa">end function</span> get_keys

  <span class="kwa">integer function</span> <span class="kwd">get_count</span><span class="opt">(</span>kNuc<span class="opt">,</span> word<span class="opt">,</span> key_bytes<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)    ::</span> kNuc
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">) ::</span> word
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)        ::</span> key_bytes
    <span class="kwa">integer</span>                    <span class="opt">::</span> m<span class="opt">,</span> hash

    <span class="kwa">call</span> <span class="kwd">djb2_hash_int64</span><span class="opt">(</span>word<span class="opt">,</span> key_bytes<span class="opt">,</span> hash<span class="opt">)</span>
    m <span class="opt">=</span> <span class="kwd">iand</span><span class="opt">(</span>hash<span class="opt">,</span> kNuc<span class="opt">%</span>maxWords<span class="opt">-</span><span class="num">1</span><span class="opt">) +</span> <span class="num">1</span>

    <span class="kwa">do</span>
       <span class="kwa">if</span> <span class="opt">(</span>kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>word <span class="opt">==</span> word <span class="opt">.</span>or<span class="opt">.</span> kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count <span class="opt">==</span> <span class="num">0</span><span class="opt">)</span> <span class="kwa">then</span>
          get_count <span class="opt">=</span> kNuc<span class="opt">%</span><span class="kwd">words</span><span class="opt">(</span>m<span class="opt">)%</span>count
          exit
       <span class="kwa">end if</span>
       m <span class="opt">=</span> <span class="kwd">merge</span><span class="opt">(</span><span class="num">1</span><span class="opt">,</span> m<span class="opt">+</span><span class="num">1</span><span class="opt">,</span> m <span class="opt">==</span> kNuc<span class="opt">%</span>maxWords<span class="opt">)</span>
    <span class="kwa">end do</span>
  <span class="kwa">end function</span> get_count

  pure <span class="kwa">subroutine</span> <span class="kwd">djb2_hash_int64</span><span class="opt">(</span>word<span class="opt">,</span> klen<span class="opt">,</span> hash<span class="opt">)</span>
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)  ::</span> word
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)         ::</span> klen
    <span class="kwa">integer</span><span class="opt">(</span>int32<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>out<span class="opt">) ::</span> hash
    <span class="kwa">integer</span><span class="opt">(</span>int32<span class="opt">)              ::</span> n
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span><span class="num">8</span><span class="opt">)            ::</span> buf

    buf <span class="opt">=</span> <span class="kwd">transfer</span><span class="opt">(</span>word<span class="opt">,</span> buf<span class="opt">)</span>
    hash <span class="opt">=</span> <span class="num">5381</span>

    <span class="kwa">do</span> n <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> klen
       hash <span class="opt">= (</span><span class="kwd">shiftl</span><span class="opt">(</span>hash<span class="opt">,</span> <span class="num">5</span><span class="opt">) +</span> hash<span class="opt">) +</span> <span class="kwd">iachar</span><span class="opt">(</span><span class="kwd">buf</span><span class="opt">(</span>n<span class="opt">:</span>n<span class="opt">))</span> <span class="slc">! hash * 33 + char</span>
    <span class="kwa">end do</span>
  <span class="kwa">end subroutine</span> djb2_hash_int64

<span class="kwa">end module</span> hash_table

<span class="kwa">program</span> knucleotide
  <span class="kwa">use</span> iso_fortran_env
  <span class="kwa">use</span> hash_table

  <span class="kwa">implicit none</span>

  <span class="kwa">integer</span><span class="opt">,</span> <span class="kwa">parameter</span>         <span class="opt">::</span> LineLen          <span class="opt">=</span> <span class="num">60</span>
  <span class="kwa">integer</span><span class="opt">,</span> <span class="kwa">parameter</span>         <span class="opt">::</span> n_lines_buf      <span class="opt">=</span> <span class="num">256</span>
  <span class="kwa">integer</span><span class="opt">,</span> <span class="kwa">parameter</span>         <span class="opt">::</span> InitialTableSize <span class="opt">=</span> <span class="num">2</span>
  <span class="kwa">integer</span>                    <span class="opt">::</span> bufferSize       <span class="opt">=</span> <span class="num">2</span><span class="opt">**</span><span class="num">20</span><span class="opt">,</span> stat
  <span class="kwa">integer</span>                    <span class="opt">::</span> total_size<span class="opt">,</span> i<span class="opt">,</span> k<span class="opt">,</span> char_as_int
  <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span>LineLen<span class="opt">)     ::</span> line<span class="opt">,</span> <span class="kwd">linebuf</span><span class="opt">(</span>n_lines_buf<span class="opt">)</span>
  <span class="kwa">integer</span><span class="opt">(</span>int8<span class="opt">),</span> allocatable <span class="opt">::</span> <span class="kwd">buffer</span><span class="opt">(:),</span> <span class="kwd">tempBuffer</span><span class="opt">(:)</span>
  <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span><span class="num">1024</span><span class="opt">)        ::</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">7</span><span class="opt">)</span>
  <span class="kwa">integer</span>                    <span class="opt">::</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">7</span><span class="opt">)</span>

  <span class="slc">! Map [a,c,g,t] and [A,C,G,T] to 0,1,2,3 (and -1 for other characters)</span>
  <span class="kwa">integer</span><span class="opt">,</span> <span class="kwa">parameter</span>   <span class="opt">::</span> <span class="kwd">encoding</span><span class="opt">(</span><span class="num">0</span><span class="opt">:</span><span class="num">255</span><span class="opt">) = &amp;</span>
       <span class="opt">[-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">0</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">2</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">3</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">0</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span> <span class="num">2</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,</span><span class="num">3</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,&amp;</span>
       <span class="opt">-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">,-</span><span class="num">1</span><span class="opt">]</span>
  <span class="slc">! Map [0, 1, 2, 3] to [A, C, G, T]</span>
  <span class="kwa">character</span><span class="opt">,</span> <span class="kwa">parameter</span> <span class="opt">::</span> <span class="kwd">decoding</span><span class="opt">(</span><span class="num">0</span><span class="opt">:</span><span class="num">3</span><span class="opt">) = [</span><span class="str">&apos;A&apos;</span><span class="opt">,</span> <span class="str">&apos;C&apos;</span><span class="opt">,</span> <span class="str">&apos;G&apos;</span><span class="opt">,</span> <span class="str">&apos;T&apos;</span><span class="opt">]</span>

  total_size <span class="opt">=</span> <span class="num">0</span>
  <span class="kwa">do</span>
     <span class="kwa">read</span><span class="opt">(*,</span> <span class="str">&quot;(a)&quot;</span><span class="opt">,</span> iostat<span class="opt">=</span>stat<span class="opt">)</span> line
     <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">line</span><span class="opt">(</span><span class="num">1</span><span class="opt">:</span><span class="num">3</span><span class="opt">) ==</span> <span class="str">&quot;&gt;TH&quot;</span><span class="opt">)</span> exit
  <span class="kwa">end do</span>

  <span class="kwd">allocate</span><span class="opt">(</span><span class="kwd">buffer</span><span class="opt">(</span>bufferSize<span class="opt">))</span>
  <span class="kwa">do</span>
     linebuf <span class="opt">=</span> <span class="str">&quot;&quot;</span>
     <span class="kwa">read</span><span class="opt">(*,</span> <span class="str">&quot;(a)&quot;</span><span class="opt">,</span> iostat<span class="opt">=</span>stat<span class="opt">)</span> linebuf

     <span class="kwa">if</span> <span class="opt">(</span>total_size<span class="opt">+</span>LineLen<span class="opt">*</span>n_lines_buf <span class="opt">&gt;</span> bufferSize<span class="opt">)</span> <span class="kwa">then</span>
        <span class="kwa">call</span> <span class="kwd">move_alloc</span><span class="opt">(</span>buffer<span class="opt">,</span> tempBuffer<span class="opt">)</span>
        <span class="kwd">allocate</span><span class="opt">(</span><span class="kwd">buffer</span><span class="opt">(</span><span class="num">2</span><span class="opt">*</span>bufferSize<span class="opt">))</span>
        <span class="kwd">buffer</span><span class="opt">(</span><span class="num">1</span><span class="opt">:</span>bufferSize<span class="opt">) =</span> tempBuffer
        <span class="kwd">deallocate</span><span class="opt">(</span>tempBuffer<span class="opt">)</span>
        bufferSize <span class="opt">=</span> <span class="num">2</span><span class="opt">*</span>bufferSize
     <span class="kwa">end if</span>

     <span class="kwa">do</span> k <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> n_lines_buf
        line <span class="opt">=</span> <span class="kwd">linebuf</span><span class="opt">(</span>k<span class="opt">)</span>
        <span class="kwa">if</span> <span class="opt">(</span>line <span class="opt">==</span> <span class="str">&quot;&quot;</span><span class="opt">)</span> exit
        <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> LineLen
           char_as_int <span class="opt">=</span> <span class="kwd">encoding</span><span class="opt">(</span><span class="kwd">iachar</span><span class="opt">(</span><span class="kwd">line</span><span class="opt">(</span>i<span class="opt">:</span>i<span class="opt">)))</span>
           <span class="kwa">if</span> <span class="opt">(</span>char_as_int <span class="opt">/= -</span><span class="num">1</span><span class="opt">)</span> <span class="kwa">then</span>
              total_size <span class="opt">=</span> total_size <span class="opt">+</span> <span class="num">1</span>
              <span class="kwd">buffer</span><span class="opt">(</span>total_size<span class="opt">) =</span> <span class="kwd">int</span><span class="opt">(</span>char_as_int<span class="opt">,</span> int8<span class="opt">)</span>
           <span class="kwa">end if</span>
        <span class="kwa">end do</span>
     <span class="kwa">end do</span>

     <span class="kwa">if</span> <span class="opt">(</span>stat <span class="opt">/=</span> <span class="num">0</span><span class="opt">)</span> exit
  <span class="kwa">end do</span>

  <span class="slc">!$omp parallel</span>
  <span class="slc">!$omp sections</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_count</span><span class="opt">(</span><span class="str">&quot;GGTATTTTAATTTATAGT&quot;</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">7</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">7</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_count</span><span class="opt">(</span><span class="str">&quot;GGTATTTTAATT&quot;</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">6</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">6</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_count</span><span class="opt">(</span><span class="str">&quot;GGTATT&quot;</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">5</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">5</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_count</span><span class="opt">(</span><span class="str">&quot;GGTA&quot;</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">4</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">4</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_count</span><span class="opt">(</span><span class="str">&quot;GGT&quot;</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">3</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">3</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_frequencies</span><span class="opt">(</span><span class="num">2</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">2</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">2</span><span class="opt">))</span>
  <span class="slc">!$omp section</span>
  <span class="kwa">call</span> <span class="kwd">write_frequencies</span><span class="opt">(</span><span class="num">1</span><span class="opt">,</span> <span class="kwd">io_buffer</span><span class="opt">(</span><span class="num">1</span><span class="opt">),</span> <span class="kwd">io_pos</span><span class="opt">(</span><span class="num">1</span><span class="opt">))</span>
  <span class="slc">!$omp end sections</span>
  <span class="slc">!$omp end parallel</span>

  <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> <span class="num">7</span>
     <span class="kwa">write</span><span class="opt">(*,</span> <span class="str">&quot;(A)&quot;</span><span class="opt">,</span> advance<span class="opt">=</span><span class="str">&quot;no&quot;</span><span class="opt">)</span> <span class="kwd">io_buffer</span><span class="opt">(</span>i<span class="opt">)(</span><span class="num">1</span><span class="opt">:</span><span class="kwd">io_pos</span><span class="opt">(</span>i<span class="opt">))</span>
  <span class="kwa">end do</span>

<span class="kwa">contains</span>

  <span class="kwa">subroutine</span> <span class="kwd">write_frequencies</span><span class="opt">(</span>length<span class="opt">,</span> buf<span class="opt">,</span> ibuf<span class="opt">)</span>
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)             ::</span> length
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=*),</span> <span class="kwd">intent</span><span class="opt">(</span>inout<span class="opt">) ::</span> buf
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>out<span class="opt">)            ::</span> ibuf
    <span class="kwa">integer</span>                         <span class="opt">::</span> numNuc<span class="opt">,</span> i<span class="opt">,</span> j
    <span class="kwa">type</span><span class="opt">(</span><span class="kwa">key</span><span class="opt">)                       ::</span> <span class="kwd">nucleotides</span><span class="opt">(</span><span class="num">4</span><span class="opt">**</span>length<span class="opt">)</span>
    <span class="kwa">type</span><span class="opt">(</span><span class="kwa">key</span><span class="opt">)                       ::</span> temp
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">)                     ::</span> kn
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span><span class="num">40</span><span class="opt">)               ::</span> nucleotide

    <span class="kwa">call</span> <span class="kwd">init_table</span><span class="opt">(</span>kn<span class="opt">,</span> InitialTableSize<span class="opt">)</span>

    numNuc <span class="opt">=</span> total_size <span class="opt">-</span> length <span class="opt">+</span> <span class="num">1</span>
    <span class="kwa">call</span> <span class="kwd">read_frame</span><span class="opt">(</span>buffer<span class="opt">,</span> numNuc<span class="opt">,</span> length<span class="opt">,</span> kn<span class="opt">)</span>

    nucleotides <span class="opt">=</span> <span class="kwd">get_keys</span><span class="opt">(</span>kn<span class="opt">,</span> <span class="kwd">size</span><span class="opt">(</span>nucleotides<span class="opt">))</span>

    <span class="slc">! Insertion sort</span>
    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">2</span><span class="opt">,</span> <span class="kwd">size</span><span class="opt">(</span>nucleotides<span class="opt">)</span>
       temp <span class="opt">=</span> <span class="kwd">nucleotides</span><span class="opt">(</span>i<span class="opt">)</span>
       <span class="kwa">do</span> j <span class="opt">=</span> i<span class="opt">,</span> <span class="num">2</span><span class="opt">, -</span><span class="num">1</span>
          <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">-</span><span class="num">1</span><span class="opt">)%</span>count <span class="opt">&gt;</span> temp<span class="opt">%</span>count <span class="opt">.</span>or<span class="opt">.  &amp;</span>
               <span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">-</span><span class="num">1</span><span class="opt">)%</span>count <span class="opt">==</span> temp<span class="opt">%</span>count <span class="opt">.</span>and<span class="opt">.  &amp;</span>
               <span class="kwd">decode_string</span><span class="opt">(</span><span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">-</span><span class="num">1</span><span class="opt">)%</span>word<span class="opt">,</span> length<span class="opt">) &lt; &amp;</span>
               <span class="kwd">decode_string</span><span class="opt">(</span>temp<span class="opt">%</span>word<span class="opt">,</span> length<span class="opt">))</span> exit
          <span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">) =</span> <span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">-</span><span class="num">1</span><span class="opt">)</span>
       <span class="kwa">end do</span>
       <span class="kwd">nucleotides</span><span class="opt">(</span>j<span class="opt">) =</span> temp
    <span class="kwa">end do</span>

    ibuf <span class="opt">=</span> <span class="num">0</span>
    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> <span class="kwd">size</span><span class="opt">(</span>nucleotides<span class="opt">)</span>
       nucleotide <span class="opt">=</span> <span class="kwd">decode_string</span><span class="opt">(</span><span class="kwd">nucleotides</span><span class="opt">(</span>i<span class="opt">)%</span>word<span class="opt">,</span> length<span class="opt">)</span>
       <span class="kwa">write</span><span class="opt">(</span><span class="kwd">buf</span><span class="opt">(</span>ibuf<span class="opt">+</span><span class="num">1</span><span class="opt">:),</span> <span class="str">&quot;(a2,f6.3,a)&quot;</span><span class="opt">)</span> <span class="kwd">nucleotide</span><span class="opt">(</span><span class="num">1</span><span class="opt">:</span><span class="num">2</span><span class="opt">), &amp;</span>
            <span class="num">100</span><span class="opt">. *</span> <span class="kwd">nucleotides</span><span class="opt">(</span>i<span class="opt">)%</span>count <span class="opt">/</span> <span class="kwa">real</span><span class="opt">(</span>numNuc<span class="opt">),</span> <span class="kwd">new_line</span><span class="opt">(</span><span class="str">&quot; &quot;</span><span class="opt">)</span>
       ibuf <span class="opt">=</span> ibuf <span class="opt">+</span> <span class="num">9</span>
    <span class="kwa">end do</span>

    ibuf <span class="opt">=</span> ibuf <span class="opt">+</span> <span class="num">1</span>
    <span class="kwd">buf</span><span class="opt">(</span>ibuf<span class="opt">:</span>ibuf<span class="opt">) =</span> <span class="kwd">new_line</span><span class="opt">(</span><span class="str">&quot; &quot;</span><span class="opt">)</span>
  <span class="kwa">end subroutine</span> write_frequencies

  <span class="kwa">subroutine</span> <span class="kwd">write_count</span><span class="opt">(</span>string<span class="opt">,</span> buf<span class="opt">,</span> ibuf<span class="opt">)</span>
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=*),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)    ::</span> string
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=*),</span> <span class="kwd">intent</span><span class="opt">(</span>inout<span class="opt">) ::</span> buf
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>out<span class="opt">)            ::</span> ibuf

    <span class="kwa">character</span><span class="opt">,</span> <span class="kwa">parameter</span> <span class="opt">::</span> tab <span class="opt">=</span> <span class="kwd">achar</span><span class="opt">(</span><span class="num">9</span><span class="opt">)</span>
    <span class="kwa">integer</span>              <span class="opt">::</span> length<span class="opt">,</span> numNuc<span class="opt">,</span> key_bytes
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">)       ::</span> word
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">)          ::</span> kn

    <span class="kwa">call</span> <span class="kwd">init_table</span><span class="opt">(</span>kn<span class="opt">,</span> InitialTableSize<span class="opt">)</span>

    length <span class="opt">=</span> <span class="kwd">len</span><span class="opt">(</span>string<span class="opt">)</span>
    numNuc <span class="opt">=</span> total_size <span class="opt">-</span> length <span class="opt">+</span> <span class="num">1</span>
    word <span class="opt">=</span> <span class="kwd">encode_string</span><span class="opt">(</span>string<span class="opt">)</span>
    key_bytes <span class="opt">=</span> <span class="kwd">ceiling</span><span class="opt">(</span>length <span class="opt">*</span> <span class="num">0.25d0</span><span class="opt">)</span>

    <span class="kwa">call</span> <span class="kwd">read_frame</span><span class="opt">(</span>buffer<span class="opt">,</span> numNuc<span class="opt">,</span> length<span class="opt">,</span> kn<span class="opt">)</span>


    <span class="kwa">write</span><span class="opt">(</span>buf<span class="opt">,</span> <span class="str">&quot;(i0,a)&quot;</span><span class="opt">)</span> <span class="kwd">get_count</span><span class="opt">(</span>kn<span class="opt">,</span> word<span class="opt">,</span> key_bytes<span class="opt">),</span> tab<span class="opt">//</span>string<span class="opt">//</span><span class="kwd">new_line</span><span class="opt">(</span><span class="str">&quot; &quot;</span><span class="opt">)</span>
    ibuf <span class="opt">=</span> <span class="kwd">len_trim</span><span class="opt">(</span>buf<span class="opt">)</span>
  <span class="kwa">end subroutine</span> write_count

  <span class="slc">! Convert a string to int64</span>
  pure <span class="kwa">function</span> <span class="kwd">encode_string</span><span class="opt">(</span>string<span class="opt">)</span> <span class="kwd">result</span><span class="opt">(</span>x<span class="opt">)</span>
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=*),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">) ::</span> string
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">)               ::</span> x
    <span class="kwa">integer</span>                      <span class="opt">::</span> n

    x <span class="opt">=</span> <span class="num">0</span>
    <span class="kwa">do</span> n <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> <span class="kwd">len</span><span class="opt">(</span>string<span class="opt">)</span>
       x <span class="opt">=</span> <span class="kwd">shiftl</span><span class="opt">(</span>x<span class="opt">,</span> <span class="num">2</span><span class="opt">)</span>
       x <span class="opt">=</span> <span class="kwd">ior</span><span class="opt">(</span>x<span class="opt">,</span> <span class="kwd">int</span><span class="opt">(</span><span class="kwd">encoding</span><span class="opt">(</span><span class="kwd">iachar</span><span class="opt">(</span><span class="kwd">string</span><span class="opt">(</span>n<span class="opt">:</span>n<span class="opt">))),</span> int64<span class="opt">))</span>
    <span class="kwa">end do</span>
  <span class="kwa">end function</span> encode_string

  <span class="slc">! Decode an int64 to a string</span>
  pure <span class="kwa">function</span> <span class="kwd">decode_string</span><span class="opt">(</span>x<span class="opt">,</span> length<span class="opt">)</span> <span class="kwd">result</span><span class="opt">(</span>string<span class="opt">)</span>
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">) ::</span> x
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)        ::</span> length
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span>length<span class="opt">)      ::</span> string
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">)             ::</span> xc
    <span class="kwa">integer</span>                    <span class="opt">::</span> n

    xc <span class="opt">=</span> x
    <span class="kwa">do</span> n <span class="opt">=</span> length<span class="opt">,</span> <span class="num">1</span><span class="opt">, -</span><span class="num">1</span>
       <span class="kwd">string</span><span class="opt">(</span>n<span class="opt">:</span>n<span class="opt">) =</span> <span class="kwd">decoding</span><span class="opt">(</span><span class="kwd">iand</span><span class="opt">(</span>xc<span class="opt">,</span> <span class="num">3</span>_int64<span class="opt">))</span>
       xc          <span class="opt">=</span> <span class="kwd">shiftr</span><span class="opt">(</span>xc<span class="opt">,</span> <span class="num">2</span><span class="opt">)</span>
    <span class="kwa">end do</span>
  <span class="kwa">end function</span> decode_string

  <span class="kwa">subroutine</span> <span class="kwd">read_frame</span><span class="opt">(</span>char_ints<span class="opt">,</span> n<span class="opt">,</span> length<span class="opt">,</span> kNuc<span class="opt">)</span>
    <span class="kwa">integer</span><span class="opt">(</span>int8<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)  ::</span> <span class="kwd">char_ints</span><span class="opt">(</span>n<span class="opt">+</span>length<span class="opt">-</span><span class="num">1</span><span class="opt">)</span>
    <span class="kwa">integer</span><span class="opt">,</span> <span class="kwd">intent</span><span class="opt">(</span>in<span class="opt">)        ::</span> n<span class="opt">,</span> length
    <span class="kwa">type</span><span class="opt">(</span>table<span class="opt">),</span> <span class="kwd">intent</span><span class="opt">(</span>inout<span class="opt">) ::</span> kNuc
    <span class="kwa">integer</span>                    <span class="opt">::</span> i<span class="opt">,</span> key_bytes
    <span class="kwa">integer</span><span class="opt">(</span>int64<span class="opt">)             ::</span> word<span class="opt">,</span> mask
    <span class="kwa">character</span><span class="opt">(</span>len<span class="opt">=</span>length<span class="opt">)      ::</span> init_string

    <span class="slc">! Number of relevant bytes in encoded string</span>
    key_bytes <span class="opt">=</span> <span class="kwd">ceiling</span><span class="opt">(</span>length<span class="opt">*</span><span class="num">0.25d0</span><span class="opt">)</span>

    <span class="slc">! Mask to update the encoded word in the loop</span>
    mask <span class="opt">=</span> <span class="kwd">shiftl</span><span class="opt">(</span><span class="num">1</span>_int64<span class="opt">,</span> <span class="num">2</span><span class="opt">*</span>length<span class="opt">) -</span> <span class="num">1</span>

    <span class="slc">! Prepend a blank, which will be shifted out below</span>
    init_string <span class="opt">=</span> <span class="str">&quot;&quot;</span>
    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> length<span class="opt">-</span><span class="num">1</span>
       <span class="kwd">init_string</span><span class="opt">(</span><span class="num">1</span><span class="opt">+</span>i<span class="opt">:</span><span class="num">1</span><span class="opt">+</span>i<span class="opt">) =</span> <span class="kwd">decoding</span><span class="opt">(</span><span class="kwd">char_ints</span><span class="opt">(</span>i<span class="opt">))</span>
    <span class="kwa">end do</span>
    word <span class="opt">=</span> <span class="kwd">encode_string</span><span class="opt">(</span>init_string<span class="opt">)</span>

    <span class="kwa">do</span> i <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span> n
       <span class="slc">! Shift out leftmost 2 bits, and add 2 bits for new symbol</span>
       word <span class="opt">=</span> <span class="kwd">ior</span><span class="opt">(</span><span class="kwd">iand</span><span class="opt">(</span><span class="kwd">shiftl</span><span class="opt">(</span>word<span class="opt">,</span> <span class="num">2</span><span class="opt">),</span> mask<span class="opt">), &amp;</span>
            <span class="kwd">int</span><span class="opt">(</span><span class="kwd">char_ints</span><span class="opt">(</span>i<span class="opt">+</span>length<span class="opt">-</span><span class="num">1</span><span class="opt">),</span> int64<span class="opt">))</span>
       <span class="kwa">call</span> <span class="kwd">add</span><span class="opt">(</span>kNuc<span class="opt">,</span> word<span class="opt">,</span> key_bytes<span class="opt">)</span>
    <span class="kwa">end do</span>
  <span class="kwa">end subroutine</span> read_frame

<span class="kwa">end program</span> knucleotide
    </pre>
  </section>
  <section>
    <div>
      <h2 id="log">notes, command-line, and program output</h2>
    </div>
    <pre>
NOTES:
64-bit Ubuntu quad core
Intel(R) Fortran Intel(R) 64 Compiler
for applications running on Intel(R) 64,
Version 19.1.0.166 Build 20191121
Copyright (C) 1985-2019 Intel Corporation.  All rights reserved.
FOR NON-COMMERCIAL USE ONLY


Fri, 07 Feb 2020 18:54:41 GMT

MAKE:
/opt/src/intel/bin/ifort -O3 -march=core2 -qopenmp knucleotide.ifc-2.f90 -o knucleotide.ifc-2.ifc_run
rm knucleotide.ifc-2.f90

4.71s to complete and log all make actions

COMMAND LINE:
./knucleotide.ifc-2.ifc_run 0 &lt; knucleotide-input25000000.txt

PROGRAM OUTPUT:
A 30.295
T 30.151
C 19.800
G 19.754

AA 9.177
TA 9.132
AT 9.131
TT 9.091
CA 6.002
AC 6.001
AG 5.987
GA 5.984
CT 5.971
TC 5.971
GT 5.957
TG 5.956
CC 3.917
GC 3.911
CG 3.909
GG 3.902

1471758	GGT
446535	GGTA
47336	GGTATT
893	GGTATTTTAATT
893	GGTATTTTAATTTATAGT
    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="https://salsa.debian.org/benchmarksgame-team/benchmarksgame/blob/master/README.md"><span>Contribute your own program</span></a>
      <li><a href="../license.html"><span>3-Clause BSD License</span></a>
    </ul>
  </nav>
</footer>

