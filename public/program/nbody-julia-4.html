<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>n-body Julia&nbsp;#4 program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding:0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans, Ubuntu, Verdana, sans-serif;margin:0;-webkit-text-size-adjust:100%}h3, h1, h2, li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h3{font-size:1.4em;font-weight:bold;margin:0;padding: .4em}h3, h3 a{color:white;background-color:#dd4814}h3 small{font-size:0.64em}h1,h2{margin:1.5em 0 0}h1{font-size:1.4em;font-weight:normal}h2{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin: .5em .5em 0;padding: .5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin: .3em 0 0}p a, a span{border-bottom: .1em solid #333;padding-bottom: .1em}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width: 60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="./favicon.ico">
<header>
  <h3><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/">The&nbsp;<small>Computer&nbsp;Language</small><br>Benchmarks&nbsp;Game</a></h3>
</header>
<article>
  <div>
    <h1>n-body Julia&nbsp;#4 program</h1>
    <aside>
      <p><a href="../description/nbody.html#nbody">description</a>
    </aside>
  </div>
  <section>
    </div>
      <h2>source code</h2>
    </div>
    <pre>
<span class="slc"># The Computer Language Benchmarks Game</span>
<span class="slc"># https://salsa.debian.org/benchmarksgame-team/benchmarksgame/</span>
<span class="slc">#</span>
<span class="slc"># Contributed by Adam Beckmeyer</span>

<span class="kwa">import</span> Printf<span class="opt">:</span> <span class="kwc">&#64;printf</span>

<span class="kwa">const</span> DAYS_PER_YEAR <span class="opt">=</span> <span class="num">365.24</span>
<span class="kwa">const</span> SOLAR_MASS <span class="opt">=</span> <span class="num">4</span> <span class="opt">*</span> π <span class="opt">*</span> π

<span class="slc"># Use a tuple rather than struct to hint compiler towards simd code</span>
<span class="slc"># 4 floats in tuple instead of 3 generates better SIMD instructions</span>
<span class="kwa">const</span> V3d <span class="opt">=</span> NTuple<span class="opt">{</span><span class="num">4</span><span class="opt">,</span><span class="kwb">Float64</span><span class="opt">}</span>
<span class="kwd">V3d</span><span class="opt">(</span>x<span class="opt">=</span><span class="num">0.0</span><span class="opt">,</span> y<span class="opt">=</span><span class="num">0.0</span><span class="opt">,</span> z<span class="opt">=</span><span class="num">0.0</span><span class="opt">) = (</span><span class="kwb">Float64</span><span class="opt">(</span>x<span class="opt">),</span> <span class="kwb">Float64</span><span class="opt">(</span>y<span class="opt">),</span> <span class="kwb">Float64</span><span class="opt">(</span>z<span class="opt">),</span> <span class="num">0.0</span><span class="opt">)</span>

<span class="slc"># Rust implementation #7 uses pos and v of length 3 with 1 filler</span>
<span class="slc"># Float64 field for a total struct width of 64 bytes instead of 72</span>
<span class="slc"># bytes as shown currently. This might be possible for Julia in the</span>
<span class="slc"># future using https://github.com/eschnett/SIMD.jl. Not sure if it</span>
<span class="slc"># would actually be advantageous though.</span>
<span class="kwa">struct</span> Body
    pos<span class="opt">::</span>V3d
    v<span class="opt">::</span>V3d
    m<span class="opt">::</span><span class="kwb">Float64</span>
<span class="kwa">end</span><span class="slc">#struct</span>

<span class="slc"># don&apos;t bother adding the empty 4th element</span>
Base<span class="opt">.</span><span class="kwd">sum</span><span class="opt">(</span>v<span class="opt">::</span>V3d<span class="opt">) =</span> <span class="kwc">&#64;inbounds</span> <span class="opt">+(</span>v<span class="opt">[</span><span class="num">1</span><span class="opt">],</span> v<span class="opt">[</span><span class="num">2</span><span class="opt">],</span> v<span class="opt">[</span><span class="num">3</span><span class="opt">])</span>

<span class="kwa">function</span> <span class="kwd">init_sun</span><span class="opt">(</span>bodies<span class="opt">)</span>
    p <span class="opt">=</span> <span class="kwd">V3d</span><span class="opt">()</span>
    <span class="kwa">for</span> b <span class="kwa">in</span> bodies
        p <span class="opt">=</span> muladd<span class="opt">.(</span>b<span class="opt">.</span>v<span class="opt">,</span> b<span class="opt">.</span>m<span class="opt">,</span> p<span class="opt">)</span>
    <span class="kwa">end</span><span class="slc">#for</span>
    <span class="kwd">Body</span><span class="opt">(</span><span class="kwd">V3d</span><span class="opt">(),</span> p <span class="opt">.* (-</span><span class="kwd">inv</span><span class="opt">(</span>SOLAR_MASS<span class="opt">)),</span> SOLAR_MASS<span class="opt">)</span>
<span class="kwa">end</span><span class="slc">#function</span>

Base<span class="opt">.</span><span class="kwc">&#64;propagate_inbounds</span> <span class="kwa">function</span> <span class="kwd">update_velocity</span><span class="opt">(</span>b1<span class="opt">,</span> b2<span class="opt">,</span> Δt<span class="opt">)</span>
    Δpos <span class="opt">=</span> b1<span class="opt">.</span>pos <span class="opt">.-</span> b2<span class="opt">.</span>pos
    d² <span class="opt">=</span> <span class="kwd">sum</span><span class="opt">(</span>Δpos <span class="opt">.*</span> Δpos<span class="opt">)</span>

    <span class="slc"># Fastest implementations use an intrinsic to do a</span>
    <span class="slc"># single-precision sqrt approximation followed by two iterations</span>
    <span class="slc"># of the Newton-Raphson method. But the sqrt isn&apos;t currently this</span>
    <span class="slc"># implementations bottleneck, so I&apos;ve left it unoptimized.</span>

    <span class="slc"># The fastest Rust/C implementations store this value instead of</span>
    <span class="slc"># immediately modifying the body objects. Possible performance</span>
    <span class="slc"># gains there due to cache-locality? I&apos;ve been unable to replicate</span>
    <span class="slc"># this in Julia by calculating mag as an NTuple{10,Float64}.</span>
    mag <span class="opt">=</span> Δt <span class="opt">/ (</span>d² <span class="opt">*</span> √d²<span class="opt">)</span>
    <span class="opt">(</span><span class="kwd">Body</span><span class="opt">(</span>b1<span class="opt">.</span>pos<span class="opt">,</span> muladd<span class="opt">.(-</span>b2<span class="opt">.</span>m <span class="opt">*</span> mag<span class="opt">,</span> Δpos<span class="opt">,</span> b1<span class="opt">.</span>v<span class="opt">),</span> b1<span class="opt">.</span>m<span class="opt">),</span>
     <span class="kwd">Body</span><span class="opt">(</span>b2<span class="opt">.</span>pos<span class="opt">,</span> muladd<span class="opt">.(</span>b1<span class="opt">.</span>m <span class="opt">*</span> mag<span class="opt">,</span> Δpos<span class="opt">,</span> b2<span class="opt">.</span>v<span class="opt">),</span> b2<span class="opt">.</span>m<span class="opt">))</span>
<span class="kwa">end</span><span class="slc">#function</span>

Base<span class="opt">.</span><span class="kwc">&#64;propagate_inbounds</span> <span class="kwd">update_pos</span><span class="opt">(</span>b<span class="opt">,</span> Δt<span class="opt">) =</span>
    <span class="kwd">Body</span><span class="opt">(</span>muladd<span class="opt">.(</span>b<span class="opt">.</span>v<span class="opt">,</span> Δt<span class="opt">,</span> b<span class="opt">.</span>pos<span class="opt">),</span> b<span class="opt">.</span>v<span class="opt">,</span> b<span class="opt">.</span>m<span class="opt">)</span>

<span class="kwa">function</span> <span class="kwd">next</span><span class="opt">!(</span>bodies<span class="opt">,</span> Δt<span class="opt">)</span>
    <span class="slc"># Using special iteration tools like eachindex or Iterators.drop</span>
    <span class="slc"># is actually measurably slower than for loop around a UnitRange</span>
    <span class="kwc">&#64;inbounds</span> <span class="kwa">for</span> i <span class="kwa">in</span> <span class="num">1</span><span class="opt">:</span><span class="kwd">length</span><span class="opt">(</span>bodies<span class="opt">),</span> j <span class="kwa">in</span> i<span class="opt">+</span><span class="num">1</span><span class="opt">:</span><span class="kwd">length</span><span class="opt">(</span>bodies<span class="opt">)</span>
        <span class="slc"># Script spends roughly 90% of it&apos;s time in this loop. Of that</span>
        <span class="slc"># 90%, 36% is spent on float multiplication, 34% is spent on</span>
        <span class="slc"># the call to muladd, 12% is spent on vector manipulation and</span>
        <span class="slc"># iteration overhead, 11% is spent on division, 2% is spent on</span>
        <span class="slc"># sqrt, 2% is spent on summing. The remaining 3% is</span>
        <span class="slc"># unaccounted for. Overall, multiplication (including muladd)</span>
        <span class="slc"># dominates this benchmark.</span>
        bodies<span class="opt">[</span>i<span class="opt">],</span> bodies<span class="opt">[</span>j<span class="opt">] =</span> <span class="kwd">update_velocity</span><span class="opt">(</span>bodies<span class="opt">[</span>i<span class="opt">],</span> bodies<span class="opt">[</span>j<span class="opt">],</span> Δt<span class="opt">)</span>
    <span class="kwa">end</span><span class="slc">#for</span>

    <span class="slc"># this could be broadcast or mapped, but for-loop is faster</span>
    <span class="kwc">&#64;inbounds</span> <span class="kwa">for</span> i <span class="kwa">in</span> <span class="num">1</span><span class="opt">:</span><span class="kwd">length</span><span class="opt">(</span>bodies<span class="opt">)</span>
        bodies<span class="opt">[</span>i<span class="opt">] =</span> <span class="kwd">update_pos</span><span class="opt">(</span>bodies<span class="opt">[</span>i<span class="opt">],</span> Δt<span class="opt">)</span>
    <span class="kwa">end</span><span class="slc">#for</span>
<span class="kwa">end</span><span class="slc">#function</span>

<span class="kwa">function</span> <span class="kwd">energy</span><span class="opt">(</span>bodies<span class="opt">)</span>
    e <span class="opt">=</span> <span class="num">0.0</span>
    <span class="kwc">&#64;inbounds</span> <span class="kwa">for</span> i <span class="kwa">in</span> <span class="num">1</span><span class="opt">:</span><span class="kwd">length</span><span class="opt">(</span>bodies<span class="opt">)</span>
        bi <span class="opt">=</span> bodies<span class="opt">[</span>i<span class="opt">]</span>
        e <span class="opt">+=</span> <span class="num">0.5</span> <span class="opt">*</span> bi<span class="opt">.</span>m <span class="opt">*</span> <span class="kwd">sum</span><span class="opt">(</span>bi<span class="opt">.</span>v <span class="opt">.*</span> bi<span class="opt">.</span>v<span class="opt">)</span>
        <span class="kwa">for</span> j <span class="kwa">in</span> i<span class="opt">+</span><span class="num">1</span><span class="opt">:</span><span class="kwd">length</span><span class="opt">(</span>bodies<span class="opt">)</span>
            bj <span class="opt">=</span> bodies<span class="opt">[</span>j<span class="opt">]</span>
            Δpos <span class="opt">=</span> bi<span class="opt">.</span>pos <span class="opt">.-</span> bj<span class="opt">.</span>pos
            d <span class="opt">=</span> √<span class="kwd">sum</span><span class="opt">(</span>Δpos <span class="opt">.*</span> Δpos<span class="opt">)</span>
            e <span class="opt">=</span> <span class="kwd">muladd</span><span class="opt">(</span>bi<span class="opt">.</span>m <span class="opt">*</span> bj<span class="opt">.</span>m<span class="opt">, -</span><span class="kwd">inv</span><span class="opt">(</span>d<span class="opt">),</span> e<span class="opt">)</span>
        <span class="kwa">end</span><span class="slc">#for</span>
    <span class="kwa">end</span><span class="slc">#for</span>
    e
<span class="kwa">end</span><span class="slc">#function</span>

<span class="kwa">function</span> <span class="kwd">main</span><span class="opt">(</span>io<span class="opt">,</span> n<span class="opt">,</span> Δt<span class="opt">)</span>
    jupyter <span class="opt">=</span> <span class="kwd">Body</span><span class="opt">(</span><span class="kwd">V3d</span><span class="opt">(</span><span class="num">4.84143144246472090e+00</span><span class="opt">,</span>
                       <span class="opt">-</span><span class="num">1.16032004402742839e+00</span><span class="opt">,</span>
                       <span class="opt">-</span><span class="num">1.03622044471123109e-01</span><span class="opt">),</span>
                   <span class="kwd">V3d</span><span class="opt">(</span><span class="num">1.66007664274403694e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                       <span class="num">7.69901118419740425e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                       <span class="opt">-</span><span class="num">6.90460016972063023e-05</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">),</span>
                   <span class="num">9.54791938424326609e-04</span> <span class="opt">*</span> SOLAR_MASS<span class="opt">)</span>
    saturn <span class="opt">=</span> <span class="kwd">Body</span><span class="opt">(</span><span class="kwd">V3d</span><span class="opt">(</span><span class="num">8.34336671824457987e+00</span><span class="opt">,</span>
                      <span class="num">4.12479856412430479e+00</span><span class="opt">,</span>
                      <span class="opt">-</span><span class="num">4.03523417114321381e-01</span><span class="opt">),</span>
                  <span class="kwd">V3d</span><span class="opt">(-</span><span class="num">2.76742510726862411e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                      <span class="num">4.99852801234917238e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                      <span class="num">2.30417297573763929e-05</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">),</span>
                  <span class="num">2.85885980666130812e-04</span> <span class="opt">*</span> SOLAR_MASS<span class="opt">)</span>
    uranus <span class="opt">=</span> <span class="kwd">Body</span><span class="opt">(</span><span class="kwd">V3d</span><span class="opt">(</span><span class="num">1.28943695621391310e+01</span><span class="opt">,</span>
                      <span class="opt">-</span><span class="num">1.51111514016986312e+01</span><span class="opt">,</span>
                      <span class="opt">-</span><span class="num">2.23307578892655734e-01</span><span class="opt">),</span>
                  <span class="kwd">V3d</span><span class="opt">(</span><span class="num">2.96460137564761618e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                      <span class="num">2.37847173959480950e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                      <span class="opt">-</span><span class="num">2.96589568540237556e-05</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">),</span>
                  <span class="num">4.36624404335156298e-05</span> <span class="opt">*</span> SOLAR_MASS<span class="opt">)</span>
    neptune <span class="opt">=</span> <span class="kwd">Body</span><span class="opt">(</span><span class="kwd">V3d</span><span class="opt">(</span><span class="num">1.53796971148509165e+01</span><span class="opt">,</span>
                       <span class="opt">-</span><span class="num">2.59193146099879641e+01</span><span class="opt">,</span>
                       <span class="num">1.79258772950371181e-01</span><span class="opt">),</span>
                   <span class="kwd">V3d</span><span class="opt">(</span><span class="num">2.68067772490389322e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                       <span class="num">1.62824170038242295e-03</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">,</span>
                       <span class="opt">-</span><span class="num">9.51592254519715870e-05</span> <span class="opt">*</span> DAYS_PER_YEAR<span class="opt">),</span>
                   <span class="num">5.15138902046611451e-05</span> <span class="opt">*</span> SOLAR_MASS<span class="opt">)</span>
    sun <span class="opt">=</span> <span class="kwd">init_sun</span><span class="opt">((</span>jupyter<span class="opt">,</span> saturn<span class="opt">,</span> uranus<span class="opt">,</span> neptune<span class="opt">))</span>
    <span class="slc"># Although bodies is fixed size, vector instead of tuple for mutability</span>
    bodies <span class="opt">= [</span>sun<span class="opt">,</span> jupyter<span class="opt">,</span> saturn<span class="opt">,</span> uranus<span class="opt">,</span> neptune<span class="opt">]</span>

    <span class="kwc">&#64;printf</span><span class="opt">(</span>io<span class="opt">,</span> <span class="str">&quot;%.9f</span><span class="esc">\n</span><span class="str">&quot;</span><span class="opt">,</span> <span class="kwd">energy</span><span class="opt">(</span>bodies<span class="opt">))</span>
    <span class="kwa">for</span> i <span class="kwa">in</span> <span class="num">1</span><span class="opt">:</span>n
        <span class="kwd">next</span><span class="opt">!(</span>bodies<span class="opt">,</span> Δt<span class="opt">)</span>
    <span class="kwa">end</span><span class="slc">#for</span>
    <span class="kwc">&#64;printf</span><span class="opt">(</span>io<span class="opt">,</span> <span class="str">&quot;%.9f</span><span class="esc">\n</span><span class="str">&quot;</span><span class="opt">,</span> <span class="kwd">energy</span><span class="opt">(</span>bodies<span class="opt">))</span>
<span class="kwa">end</span><span class="slc">#function</span>

<span class="kwd">isinteractive</span><span class="opt">() ||</span> <span class="kwd">main</span><span class="opt">(</span>stdout<span class="opt">,</span> <span class="kwd">parse</span><span class="opt">(</span>Int<span class="opt">,</span> ARGS<span class="opt">[</span><span class="num">1</span><span class="opt">]),</span> <span class="num">0.01</span><span class="opt">)</span>
    </pre>
  </section>
  <section>
    <h2 id="log">notes, command-line, and program output</h2>
    <pre>
NOTES:
64-bit Ubuntu quad core
julia version 1.1.0
export JULIA_NUM_THREADS=4


Thu, 08 Aug 2019 16:25:54 GMT

COMMAND LINE:
/opt/src/julia-1.1.0/bin/julia -O3  -- nbody.julia-4.julia 50000000

PROGRAM OUTPUT:
-0.169075164
-0.169059907
    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="../license.html"><span>3-Clause BSD License</span></a>
    </ul>
  </nav>
</footer>

