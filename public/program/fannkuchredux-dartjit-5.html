<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>fannkuch-redux Dart JIT&nbsp;#5 program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding:0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans, Ubuntu, Verdana, sans-serif;margin:0;-webkit-text-size-adjust:100%}h3, h1, h2, li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h3{font-size:1.4em;font-weight:bold;margin:0;padding: .4em}h3, h3 a{color:white;background-color:#77216f}h3 small{font-size:0.64em}h1,h2{margin:1.5em 0 0}h1{font-size:1.4em;font-weight:normal}h2{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin: .5em .5em 0;padding: .5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin: .3em 0 0}p a, a span{border-bottom: .1em solid #333;padding-bottom: .1em}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width: 60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="../favicon.ico">
<header>
  <h3><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/index.html">The&nbsp;<small>Computer&nbsp;Language</small><br>Benchmarks&nbsp;Game</a></h3>
</header>
<article>
  <div>
    <h1>fannkuch-redux Dart JIT&nbsp;#5 program</h1>
    <aside>
      <p><a href="../description/fannkuchredux.html#fannkuchredux">description</a>
    </aside>
  </div>
  <section>
    <div>
      <h2>source code</h2>
    </div>
    <pre>
/* The Computer Language Benchmarks Game
   https://salsa.debian.org/benchmarksgame-team/benchmarksgame/

   transliterated from Andrey Filatkin&apos;s Node #5 program by Isaac Gouy
*/

import &apos;dart:io&apos;;
import &apos;dart:isolate&apos;;
import &apos;dart:math&apos;;
import &apos;dart:typed_data&apos;;

var fact = &lt;int&gt;[];

void fillFact(int n) {
  fact.add(1);
  for (var i = 1; i &lt;= n; i++) {
    fact.add(fact[i - 1] * i);
  }
}

Int32List fannkuch(int n, int idxMin, int idxMax) {
  if (fact.isEmpty) {
    fillFact(n);
  }
  final p = Int32List(n);
  final pp = Int32List(n);
  final count = Int32List(n);

  // first permutation
  for (var i = 0; i &lt; n; i++) {
    p[i] = i;
  }
  int idx = idxMin;
  for (var i = n - 1; i &gt; 0; i--) {
    final d = div(idx, fact[i]);
    count[i] = d;
    idx = idx % fact[i];

    for (var j = 0; j &lt; n; j++) {
      pp[j] = p[j];
    }

    for (var j = 0; j &lt;= i; j++) {
      if (j + d &lt;= i) {
        p[j] = pp[j + d];
      } else {
        p[j] = pp[j + d - i - 1];
      }
    }
  }

  var maxFlips = 1;
  var checkSum = 0;

  idx = idxMin;
  for (var sign = true;; sign = !sign) {
    var first = p[0];
    if (first != 0) {
      var flips = 1;
      if (p[first] != 0) {
        for (var j = 1; j &lt; n; j++) {
          pp[j] = p[j];
        }
        var p0 = first;
        while (true) {
          flips++;
          var i = 1;
          var j = p0 - 1;
          while (i &lt; j) {
            final t = pp[i];
            pp[i] = pp[j];
            pp[j] = t;
            i++;
            j--;
          }
          final t = pp[p0];
          pp[p0] = p0;
          p0 = t;
          if (pp[p0] == 0) {
            break;
          }
        }
      }

      if (maxFlips &lt; flips) {
        maxFlips = flips;
      }
      if (sign) {
        checkSum += flips;
      } else {
        checkSum -= flips;
      }
    }

    idx++;
    if (idx == idxMax) {
      break;
    }

    // next permutation
    if (sign) {
      p[0] = p[1];
      p[1] = first;
    } else {
      final t = p[1];
      p[1] = p[2];
      p[2] = t;
      for (var k = 2;; k++) {
        count[k]++;
        if (count[k] &lt;= k) {
          break;
        }
        count[k] = 0;
        for (var j = 0; j &lt;= k; j++) {
          p[j] = p[j + 1];
        }
        p[k + 1] = first;
        first = p[0];
      }
    }
  }
  // Fixed-length with type.
  return Int32List.fromList([maxFlips, checkSum]);
}

int div(int val, int by) {
  return (val - val % by) ~/ by;
}

void main(List&lt;String&gt; args) {
  final mainIsolate = ReceivePort();
  var i = Platform.numberOfProcessors;
  while (i-- &gt; 0) {
    Isolate.spawn(other, mainIsolate.sendPort);
  }

  final n = (args.length &gt; 0) ? int.parse(args[0]) : 7;
  fillFact(n);

  const nchunks = 720;
  var chunkSize = div((fact[n] + nchunks - 1), nchunks);
  chunkSize += chunkSize % 2;

  final requests = &lt;Request&gt;[];
  final len = div((fact[n] + chunkSize - 1), chunkSize);
  for (var i = 0; i &lt; len; i++) {
    final idxMin = chunkSize * i;
    final idxMax = min(fact[n], idxMin + chunkSize);
    requests.add(Request(n, idxMin, idxMax));
  }
  var awaited = requests.length;
  var flips = 0, chk = 0;

  mainIsolate.listen((dynamic p) {
    if (p is SendPort) {
      if (requests.isNotEmpty) {
        p.send(requests.removeLast());
      }
    } else if (p is Int32List) {
      if (flips &lt; p.first) {
        flips = p.first;
      }
      chk += p.last;

      if (--awaited == 0) {
        print(&quot;$chk\nPfannkuchen($n) = $flips&quot;);
        mainIsolate.close();
      }
    }
  });
}

void other(SendPort p) {
  final otherIsolate = ReceivePort();
  p.send(otherIsolate.sendPort);

  otherIsolate.listen((dynamic ini) {
    if (ini is Request) {
      p.send(fannkuch(ini.n, ini.idxMin, ini.idxMax));
      p.send(otherIsolate.sendPort);
    }
  });
}

class Request {
  int n = 0, idxMin = 0, idxMax = 0;
  Request(this.n, this.idxMin, this.idxMax);
}
    </pre>
  </section>
  <section>
    <div>
      <h2 id="log">notes, command-line, and program output</h2>
    </div>
    <pre>
NOTES:
64-bit Ubuntu quad core
Dart SDK version: 2.13.1 (stable) (Fri May 21 12:45:36 2021 +0200) on "linux_x64"


Thu, 03 Jun 2021 23:07:31 GMT

MAKE:
/opt/src/dart-sdk/bin/dart analyze 
Analyzing tmp...
No issues found!

2.44s to complete and log all make actions

COMMAND LINE:
/opt/src/dart-sdk/bin/dart run  fannkuchredux.dartjit-5.dartjit 12

PROGRAM OUTPUT:
3968050
Pfannkuchen(12) = 65
    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="../license.html"><span>3-Clause BSD License</span></a>
    </ul>
  </nav>
</footer>

